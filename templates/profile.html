<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Cá Nhân - CS466</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-control {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-outline-secondary {
            border: 2px solid #6c757d;
            color: #6c757d;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }
        
        .password-section {
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .expand-content {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .expand-content.show {
            display: block;
        }
        
        .toggle-2fa {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .alert {
            border: none;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e85a4f 100%);
            color: white;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
        }
        
        .otp-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .otp-input {
            flex: 1;
        }
        
        .send-otp-btn {
            white-space: nowrap;
        }
        
        .readonly-field {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .password-requirements {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #e9ecef;
        }
        
        .requirement-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .requirement-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            min-width: calc(50% - 4px);
        }
        
        .requirement-item.valid {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .requirement-item.valid i {
            color: #28a745 !important;
        }
        
        .requirement-item.valid i:before {
            content: "\f00c"; /* fa-check */
        }
        
        .requirement-item small {
            font-size: 11px;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>CS466 Learning System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" onclick="goBack()">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại Dashboard
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Đăng xuất
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="profile-container">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>
        
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h2 class="mb-1" id="headerFullName">Đang tải...</h2>
                    <p class="mb-0 opacity-75" id="headerEmail">Đang tải...</p>
                    <small class="opacity-75" id="headerRole">Đang tải...</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Cột 1: Thông tin cơ bản -->
            <div class="col-lg-6">
                <div class="profile-card">
                    <h4 class="section-title">
                        <i class="fas fa-user-edit me-2"></i>Thông tin cơ bản
                    </h4>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="fullName" name="full_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control readonly-field" id="email" name="email" readonly>
                            <small class="text-muted">Email không thể thay đổi</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control" id="birthDate" name="birth_date">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Giới tính</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">Chưa chọn</option>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Cột 2: Bảo mật -->
            <div class="col-lg-6">
                <div class="profile-card">
                    <h4 class="section-title">
                        <i class="fas fa-shield-alt me-2"></i>Bảo mật
                    </h4>
                    
                    <!-- Đổi mật khẩu -->
                    <div class="password-section">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="togglePasswordSection()">
                            <i class="fas fa-key me-2"></i>Đổi mật khẩu
                            <i class="fas fa-chevron-down ms-2" id="passwordChevron"></i>
                        </button>
                        
                        <div class="expand-content" id="passwordSection">
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label class="form-label">Mật khẩu hiện tại</label>
                                    <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Mật khẩu mới</label>
                                    <input type="password" class="form-control" id="newPassword" name="new_password" required>
                                    <div class="password-requirements mt-2">
                                        <small class="text-muted mb-1 d-block">Yêu cầu mật khẩu:</small>
                                        <div class="requirement-list">
                                            <div class="requirement-item" id="req-length">
                                                <i class="fas fa-times text-danger me-1"></i>
                                                <small>Ít nhất 6 ký tự</small>
                                            </div>
                                            <div class="requirement-item" id="req-uppercase">
                                                <i class="fas fa-times text-danger me-1"></i>
                                                <small>Ít nhất 1 chữ in hoa</small>
                                            </div>
                                            <div class="requirement-item" id="req-number">
                                                <i class="fas fa-times text-danger me-1"></i>
                                                <small>Ít nhất 1 chữ số</small>
                                            </div>
                                            <div class="requirement-item" id="req-letter">
                                                <i class="fas fa-times text-danger me-1"></i>
                                                <small>Có chữ cái</small>
                                            </div>
                                            <div class="requirement-item" id="req-special">
                                                <i class="fas fa-times text-danger me-1"></i>
                                                <small>Không chứa ký tự đặc biệt</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Mã OTP</label>
                                    <div class="otp-section">
                                        <input type="text" class="form-control otp-input" id="otpCode" name="otp" placeholder="Nhập mã OTP" required>
                                        <button type="button" class="btn btn-outline-primary send-otp-btn" onclick="sendOTP()">
                                            <i class="fas fa-paper-plane me-1"></i>Gửi OTP
                                        </button>
                                    </div>
                                    <small class="text-muted">OTP sẽ được gửi đến email của bạn</small>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="changePassword()">
                                    <i class="fas fa-save me-1"></i>Cập nhật mật khẩu
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 2FA Toggle -->
                    <div class="mt-4">
                        <h6 class="mb-3">Xác thực 2 bước</h6>
                        <div class="toggle-2fa">
                            <div>
                                <strong>Bật xác thực 2 bước</strong>
                                <br>
                                <small class="text-muted">Tăng cường bảo mật cho tài khoản</small>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="toggle2FA">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="text-center mt-4">
            <button type="button" class="btn btn-primary btn-lg" onclick="saveProfile()">
                <i class="fas fa-save me-2"></i>Lưu thay đổi
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let userProfile = null;

        // Load profile data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            setupPasswordValidation();
            setup2FAToggle();
        });

        function setupPasswordValidation() {
            const newPasswordInput = document.getElementById('newPassword');
            
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                updatePasswordRequirements(password);
                
                if (password.length > 0) {
                    const validation = validatePasswordDetailed(password);
                    const allValid = Object.values(validation).every(v => v);
                    
                    if (allValid) {
                        this.style.borderColor = '#28a745';
                        this.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
                    } else {
                        this.style.borderColor = '#dc3545';
                        this.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                    }
                } else {
                    this.style.borderColor = '#dee2e6';
                    this.style.boxShadow = 'none';
                    resetPasswordRequirements();
                }
            });
        }

        function validatePasswordDetailed(password) {
            const specialChars = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/;
            
            return {
                length: password.length >= 6,
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                letter: /[a-zA-Z]/.test(password),
                noSpecial: !specialChars.test(password)
            };
        }

        function updatePasswordRequirements(password) {
            const validation = validatePasswordDetailed(password);
            
            // Update length requirement
            updateRequirementItem('req-length', validation.length);
            
            // Update uppercase requirement  
            updateRequirementItem('req-uppercase', validation.uppercase);
            
            // Update number requirement
            updateRequirementItem('req-number', validation.number);
            
            // Update letter requirement
            updateRequirementItem('req-letter', validation.letter);
            
            // Update special chars requirement
            updateRequirementItem('req-special', validation.noSpecial);
        }

        function updateRequirementItem(itemId, isValid) {
            const item = document.getElementById(itemId);
            const icon = item.querySelector('i');
            
            if (isValid) {
                item.classList.add('valid');
                icon.className = 'fas fa-check text-success me-1';
            } else {
                item.classList.remove('valid');
                icon.className = 'fas fa-times text-danger me-1';
            }
        }

        function resetPasswordRequirements() {
            const items = ['req-length', 'req-uppercase', 'req-number', 'req-letter', 'req-special'];
            items.forEach(itemId => {
                updateRequirementItem(itemId, false);
            });
        }

        function setup2FAToggle() {
            const toggle2FA = document.getElementById('toggle2FA');
            
            toggle2FA.addEventListener('change', async function() {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        showAlert('Vui lòng đăng nhập lại', 'danger');
                        return;
                    }

                    const response = await fetch('/api/profile/toggle-2fa', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update checkbox theo kết quả từ server
                        this.checked = data.is_2fa_enabled;
                        showAlert(data.message, 'success');
                    } else {
                        // Revert checkbox nếu lỗi
                        this.checked = !this.checked;
                        showAlert(data.message || 'Lỗi cập nhật 2FA', 'danger');
                    }

                } catch (error) {
                    console.error('Error toggling 2FA:', error);
                    // Revert checkbox nếu lỗi
                    this.checked = !this.checked;
                    showAlert('Lỗi kết nối. Vui lòng thử lại.', 'danger');
                }
            });
        }

        async function loadProfile() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }

                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userProfile = data.profile;
                    populateForm(userProfile);
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('Lỗi tải thông tin hồ sơ', 'danger');
            }
        }

        function populateForm(profile) {
            // Header info
            document.getElementById('headerFullName').textContent = profile.full_name || 'Chưa cập nhật';
            document.getElementById('headerEmail').textContent = profile.email || '';
            document.getElementById('headerRole').textContent = profile.role === 'teacher' ? 'Giáo viên' : 'Sinh viên';

            // Form fields
            document.getElementById('fullName').value = profile.full_name || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('birthDate').value = profile.birth_date || '';
            document.getElementById('gender').value = profile.gender || '';
            
            // 2FA toggle
            document.getElementById('toggle2FA').checked = profile.is_2fa_enabled || false;
        }

        async function saveProfile() {
            try {
                const formData = new FormData();
                formData.append('full_name', document.getElementById('fullName').value);
                formData.append('birth_date', document.getElementById('birthDate').value);
                formData.append('gender', document.getElementById('gender').value);

                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/profile/update', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(data.message, 'success');
                    loadProfile(); // Reload to update header
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Lỗi cập nhật hồ sơ', 'danger');
            }
        }

        function togglePasswordSection() {
            const section = document.getElementById('passwordSection');
            const chevron = document.getElementById('passwordChevron');
            
            section.classList.toggle('show');
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
        }

        async function sendOTP() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showAlert('Vui lòng đăng nhập lại', 'danger');
                    return;
                }

                const sendBtn = document.querySelector('.send-otp-btn');
                const originalText = sendBtn.innerHTML;
                
                // Disable button and show loading
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang gửi...';

                const response = await fetch('/api/profile/send-otp-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('OTP đã được gửi đến email của bạn. Vui lòng kiểm tra hộp thư!', 'success');
                    
                    // Countdown timer
                    let countdown = 60;
                    const timer = setInterval(() => {
                        sendBtn.innerHTML = `<i class="fas fa-clock me-1"></i>${countdown}s`;
                        countdown--;
                        
                        if (countdown < 0) {
                            clearInterval(timer);
                            sendBtn.disabled = false;
                            sendBtn.innerHTML = originalText;
                        }
                    }, 1000);
                    
                } else {
                    throw new Error(data.message || 'Gửi OTP thất bại');
                }

            } catch (error) {
                console.error('Error sending OTP:', error);
                showAlert('Lỗi gửi OTP. Vui lòng thử lại.', 'danger');
                
                // Reset button
                const sendBtn = document.querySelector('.send-otp-btn');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Gửi OTP';
            }
        }

        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const otpCode = document.getElementById('otpCode').value;

                // Validate client-side
                if (!currentPassword || !newPassword || !otpCode) {
                    showAlert('Vui lòng điền đầy đủ thông tin', 'danger');
                    return;
                }

                // Validate new password
                const detailedValidation = validatePasswordDetailed(newPassword);
                const allValid = Object.values(detailedValidation).every(v => v);
                
                if (!allValid) {
                    const passwordValidation = validatePassword(newPassword);
                    showAlert(passwordValidation.message, 'danger');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    showAlert('Vui lòng đăng nhập lại', 'danger');
                    return;
                }

                const formData = new FormData();
                formData.append('current_password', currentPassword);
                formData.append('new_password', newPassword);
                formData.append('otp', otpCode);

                const response = await fetch('/api/profile/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // Reset form và đóng section
                    document.getElementById('passwordForm').reset();
                    togglePasswordSection(); // Đóng section
                    
                } else {
                    showAlert(data.message, 'danger');
                }

            } catch (error) {
                console.error('Error changing password:', error);
                showAlert('Lỗi đổi mật khẩu. Vui lòng thử lại.', 'danger');
            }
        }

        function validatePassword(password) {
            if (password.length < 6) {
                return { valid: false, message: 'Mật khẩu phải có ít nhất 6 ký tự' };
            }

            if (!/[A-Z]/.test(password)) {
                return { valid: false, message: 'Mật khẩu phải có ít nhất 1 chữ in hoa' };
            }

            if (!/[0-9]/.test(password)) {
                return { valid: false, message: 'Mật khẩu phải có ít nhất 1 chữ số' };
            }

            if (!/[a-zA-Z]/.test(password)) {
                return { valid: false, message: 'Mật khẩu phải có ít nhất 1 chữ cái' };
            }

            const specialChars = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/;
            if (specialChars.test(password)) {
                return { valid: false, message: 'Mật khẩu không được chứa ký tự đặc biệt' };
            }

            return { valid: true, message: 'Mật khẩu hợp lệ' };
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function goBack() {
            const userRole = userProfile?.role || 'student';
            window.location.href = `/dashboard/${userRole}`;
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/';
        }
    </script>
</body>
</html> 